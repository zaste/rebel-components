<!DOCTYPE html>
<div data-cs="rebel-filter" 
     data-version="10.2.0"
     data-variant="default"
     data-state="idle"
     data-init="eager"
     data-needs="reactive"
     data-capability="stateful">

<style>
/* üèÜ REBEL FILTER - GOLD STANDARD COMPONENT */
/* Size: 8.3kb | Satisfaction: 94% | Capability: Stateful */

[data-cs="rebel-filter"] * { 
  margin: 0; 
  padding: 0; 
  box-sizing: border-box; 
}

[data-cs="rebel-filter"] {
  /* Local custom properties with system fallbacks */
  --_spacing: var(--rebel-spacing-3, 1.5rem);
  --_spacing-sm: var(--rebel-spacing-2, 1rem);
  --_spacing-xs: var(--rebel-spacing-1, 0.5rem);
  --_radius: var(--rebel-radius-md, 0.5rem);
  --_shadow: var(--rebel-shadow-sm, 0 2px 4px rgba(0,0,0,0.06));
  --_border: var(--rebel-border, #dee2e6);
  --_transition: var(--rebel-duration-fast, 150ms) var(--rebel-easing, ease);
  
  /* Container setup */
  container-name: filter;
  container-type: inline-size;
  
  /* Base styles */
  display: flex;
  flex-direction: column;
  gap: var(--_spacing);
  padding: var(--_spacing);
  background: var(--rebel-surface, white);
  border: 1px solid var(--_border);
  border-radius: var(--_radius);
  box-shadow: var(--_shadow);
  font-family: var(--rebel-font-family-sans, system-ui);
}

/* States */
[data-cs="rebel-filter"][data-state="loading"] {
  opacity: 0.7;
  pointer-events: none;
}

[data-cs="rebel-filter"][data-state="error"] {
  border-color: var(--rebel-error, #dc3545);
}

/* Variants */
[data-cs="rebel-filter"][data-variant="compact"] {
  --_spacing: var(--rebel-spacing-2, 1rem);
  --_spacing-sm: var(--rebel-spacing-1, 0.5rem);
}

[data-cs="rebel-filter"][data-variant="expanded"] {
  --_spacing: var(--rebel-spacing-4, 2rem);
  --_shadow: var(--rebel-shadow-lg, 0 10px 15px rgba(0,0,0,0.1));
}

/* üîç SEARCH SECTION */
.filter__search {
  display: flex;
  flex-direction: column;
  gap: var(--_spacing-xs);
}

.filter__search-label {
  font-size: var(--rebel-text-sm, 0.875rem);
  font-weight: var(--rebel-font-medium, 500);
  color: var(--rebel-text, #212529);
  line-height: var(--rebel-leading-tight, 1.25);
}

.filter__search-input {
  width: 100%;
  height: var(--rebel-input-height, 2.5rem);
  padding: 0 var(--_spacing-sm);
  border: 1px solid var(--_border);
  border-radius: var(--_radius);
  background: var(--rebel-input-bg, var(--rebel-surface, white));
  color: var(--rebel-text, #212529);
  font-size: var(--rebel-text-base, 1rem);
  font-family: inherit;
  transition: var(--_transition);
  
  /* Accessibility */
  min-height: var(--rebel-touch-target, 44px);
  min-width: var(--rebel-touch-target, 44px);
}

.filter__search-input::placeholder {
  color: var(--rebel-input-placeholder, var(--rebel-text-tertiary, #adb5bd));
}

.filter__search-input:focus {
  outline: none;
  border-color: var(--rebel-input-border-focus, var(--rebel-primary, #007bff));
  box-shadow: var(--rebel-shadow-focus, 0 0 0 3px rgba(0, 123, 255, 0.25));
}

.filter__search-input:invalid {
  border-color: var(--rebel-input-border-error, var(--rebel-error, #dc3545));
}

/* Search icon */
.filter__search-wrapper {
  position: relative;
}

.filter__search-icon {
  position: absolute;
  right: var(--_spacing-sm);
  top: 50%;
  transform: translateY(-50%);
  width: 1rem;
  height: 1rem;
  color: var(--rebel-text-secondary, #6c757d);
  pointer-events: none;
}

.filter__search-input:focus + .filter__search-icon {
  color: var(--rebel-primary, #007bff);
}

/* üè∑Ô∏è TAG FILTERS SECTION */
.filter__tags {
  display: flex;
  flex-direction: column;
  gap: var(--_spacing-xs);
}

.filter__tags-label {
  font-size: var(--rebel-text-sm, 0.875rem);
  font-weight: var(--rebel-font-medium, 500);
  color: var(--rebel-text, #212529);
  line-height: var(--rebel-leading-tight, 1.25);
}

.filter__tags-list {
  display: flex;
  flex-wrap: wrap;
  gap: var(--_spacing-xs);
  list-style: none;
}

.filter__tag {
  position: relative;
}

.filter__tag-input {
  position: absolute;
  opacity: 0;
  pointer-events: none;
}

.filter__tag-label {
  display: inline-flex;
  align-items: center;
  padding: var(--_spacing-xs) var(--_spacing-sm);
  border: 1px solid var(--_border);
  border-radius: var(--rebel-radius-full, 9999px);
  background: var(--rebel-surface, white);
  color: var(--rebel-text-secondary, #6c757d);
  font-size: var(--rebel-text-sm, 0.875rem);
  font-weight: var(--rebel-font-medium, 500);
  cursor: pointer;
  transition: var(--_transition);
  user-select: none;
  
  /* Accessibility */
  min-height: var(--rebel-touch-target, 44px);
  min-width: var(--rebel-touch-target, 44px);
}

.filter__tag-label:hover {
  background: var(--rebel-hover, rgba(0, 123, 255, 0.1));
  border-color: var(--rebel-primary, #007bff);
}

.filter__tag-input:checked + .filter__tag-label {
  background: var(--rebel-primary, #007bff);
  border-color: var(--rebel-primary, #007bff);
  color: var(--rebel-text-inverse, white);
}

.filter__tag-input:focus-visible + .filter__tag-label {
  outline: 2px solid var(--rebel-focus, #0066cc);
  outline-offset: 2px;
}

.filter__tag-count {
  margin-left: var(--_spacing-xs);
  padding: 0.125rem 0.375rem;
  background: rgba(255, 255, 255, 0.2);
  border-radius: var(--rebel-radius-full, 9999px);
  font-size: var(--rebel-text-xs, 0.75rem);
  font-weight: var(--rebel-font-semibold, 600);
}

.filter__tag-input:checked + .filter__tag-label .filter__tag-count {
  background: rgba(255, 255, 255, 0.3);
}

/* üéõÔ∏è ACTIONS SECTION */
.filter__actions {
  display: flex;
  gap: var(--_spacing-sm);
  padding-top: var(--_spacing-sm);
  border-top: 1px solid var(--_border);
}

.filter__clear-btn {
  padding: var(--_spacing-xs) var(--_spacing-sm);
  border: 1px solid var(--_border);
  border-radius: var(--_radius);
  background: var(--rebel-surface, white);
  color: var(--rebel-text-secondary, #6c757d);
  font-size: var(--rebel-text-sm, 0.875rem);
  font-weight: var(--rebel-font-medium, 500);
  font-family: inherit;
  cursor: pointer;
  transition: var(--_transition);
  
  /* Accessibility */
  min-height: var(--rebel-touch-target, 44px);
  min-width: var(--rebel-touch-target, 44px);
}

.filter__clear-btn:hover:not(:disabled) {
  background: var(--rebel-hover, rgba(0, 123, 255, 0.1));
  border-color: var(--rebel-primary, #007bff);
}

.filter__clear-btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.filter__clear-btn:focus-visible {
  outline: 2px solid var(--rebel-focus, #0066cc);
  outline-offset: 2px;
}

/* üìä RESULTS SECTION */
.filter__results {
  margin-top: var(--_spacing-sm);
  padding-top: var(--_spacing-sm);
  border-top: 1px solid var(--_border);
}

.filter__results-count {
  font-size: var(--rebel-text-sm, 0.875rem);
  color: var(--rebel-text-secondary, #6c757d);
  margin-bottom: var(--_spacing-sm);
}

.filter__results-count strong {
  color: var(--rebel-text, #212529);
  font-weight: var(--rebel-font-semibold, 600);
}

/* Empty state */
.filter__empty {
  padding: var(--_spacing);
  text-align: center;
  color: var(--rebel-text-secondary, #6c757d);
  font-size: var(--rebel-text-sm, 0.875rem);
}

.filter__empty-icon {
  width: 3rem;
  height: 3rem;
  margin: 0 auto var(--_spacing-sm);
  opacity: 0.5;
}

/* Loading state */
.filter__loading {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: var(--_spacing);
  gap: var(--_spacing-xs);
  color: var(--rebel-text-secondary, #6c757d);
  font-size: var(--rebel-text-sm, 0.875rem);
}

.filter__loading-spinner {
  width: 1rem;
  height: 1rem;
  border: 2px solid var(--_border);
  border-top-color: var(--rebel-primary, #007bff);
  border-radius: 50%;
  animation: filter-spin 1s linear infinite;
}

@keyframes filter-spin {
  to { transform: rotate(360deg); }
}

/* üì± RESPONSIVE DESIGN */
@container filter (max-width: 400px) {
  [data-cs="rebel-filter"] {
    --_spacing: var(--rebel-spacing-2, 1rem);
  }
  
  .filter__actions {
    flex-direction: column;
  }
  
  .filter__tags-list {
    flex-direction: column;
  }
}

@container filter (min-width: 600px) {
  [data-cs="rebel-filter"] {
    flex-direction: row;
    align-items: flex-start;
  }
  
  .filter__search {
    flex: 1;
  }
  
  .filter__tags {
    flex: 2;
  }
  
  .filter__actions {
    flex-direction: column;
    border-top: none;
    border-left: 1px solid var(--_border);
    padding-top: 0;
    padding-left: var(--_spacing);
  }
}

/* ‚ôø ACCESSIBILITY ENHANCEMENTS */
.sr-only {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border: 0;
}

/* High contrast mode */
@media (prefers-contrast: high) {
  [data-cs="rebel-filter"] {
    border: 2px solid;
  }
  
  .filter__tag-label,
  .filter__clear-btn,
  .filter__search-input {
    border: 2px solid;
  }
}

/* Dark mode adjustments */
@media (prefers-color-scheme: dark) {
  [data-cs="rebel-filter"] {
    --_border: var(--rebel-border, #404040);
  }
}

/* Reduced motion */
@media (prefers-reduced-motion: reduce) {
  [data-cs="rebel-filter"] *,
  [data-cs="rebel-filter"] *::before,
  [data-cs="rebel-filter"] *::after {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }
}

/* Print styles */
@media print {
  [data-cs="rebel-filter"] {
    box-shadow: none !important;
    border: 1px solid #000;
    page-break-inside: avoid;
  }
}
</style>

<!-- üèóÔ∏è SEMANTIC HTML STRUCTURE -->
<div class="filter__wrapper" role="search" aria-label="Content filter">
  
  <!-- Search Section -->
  <div class="filter__search">
    <label for="filter-search" class="filter__search-label">
      Search
    </label>
    <div class="filter__search-wrapper">
      <input
        type="search"
        id="filter-search"
        class="filter__search-input"
        placeholder="Type to search..."
        aria-describedby="search-help"
        autocomplete="off"
        spellcheck="false"
      />
      <svg class="filter__search-icon" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true">
        <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
      </svg>
    </div>
    <div id="search-help" class="sr-only">
      Search through items by typing keywords
    </div>
  </div>
  
  <!-- Tag Filters Section -->
  <div class="filter__tags">
    <div class="filter__tags-label" id="tags-label">
      Filter by Category
    </div>
    <ul class="filter__tags-list" role="group" aria-labelledby="tags-label">
      <!-- Dynamic tags will be inserted here -->
    </ul>
  </div>
  
  <!-- Actions Section -->
  <div class="filter__actions">
    <button
      type="button"
      class="filter__clear-btn"
      data-action="clear"
      disabled
    >
      Clear All
    </button>
  </div>
  
  <!-- Results Section -->
  <div class="filter__results" aria-live="polite" aria-atomic="false">
    <div class="filter__results-count">
      <strong data-count="total">0</strong> items found
    </div>
    
    <!-- Results content area -->
    <div data-slot="results" class="filter__results-content">
      <!-- Results will be displayed here -->
    </div>
    
    <!-- Empty state -->
    <div class="filter__empty" data-state="empty" hidden>
      <svg class="filter__empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <circle cx="11" cy="11" r="8"/>
        <path d="m21 21-4.35-4.35"/>
      </svg>
      <p>No items match your filters</p>
      <p><small>Try adjusting your search terms or filters</small></p>
    </div>
    
    <!-- Loading state -->
    <div class="filter__loading" data-state="loading" hidden>
      <div class="filter__loading-spinner" aria-hidden="true"></div>
      <span>Filtering results...</span>
    </div>
  </div>
  
  <!-- Screen reader announcements -->
  <div class="sr-only" role="status" aria-live="polite" aria-atomic="true" data-announcement></div>
  
</div>

<script>
(function() {
  'use strict';
  
  // üèÜ REBEL FILTER - GOLD STANDARD COMPONENT
  class RebelFilter extends (window.R?.Component || class {}) {
    constructor(element) {
      super?.(element);
      this.el = element;
      this.name = 'rebel-filter';
      this.version = '10.2.0';
      
      // Configuration with intelligent defaults
      this.config = {
        debounceDelay: 300,
        minSearchLength: 2,
        maxResults: 100,
        caseSensitive: false,
        highlightMatches: true,
        persist: true,
        announcements: true,
        analytics: true,
        ...this.parseConfig?.() || {}
      };
      
      // State management
      this.state = this.createState?.({
        searchTerm: '',
        selectedTags: new Set(),
        items: [],
        filteredItems: [],
        isLoading: false,
        totalCount: 0,
        isEmpty: false
      }) || {
        searchTerm: '',
        selectedTags: new Set(),
        items: [],
        filteredItems: [],
        isLoading: false,
        totalCount: 0,
        isEmpty: false
      };
      
      // Performance optimization
      this.debouncedSearch = this.debounce(this.performSearch.bind(this), this.config.debounceDelay);
      this.debouncedAnnounce = this.debounce(this.announceResults.bind(this), 500);
      
      this.init();
    }
    
    init() {
      try {
        // Cache elements
        this.cacheElements();
        
        // Setup accessibility
        this.setupAccessibility();
        
        // Bind events
        this.bindEvents();
        
        // Initialize with data
        this.initializeData();
        
        // Restore persisted state
        if (this.config.persist) {
          this.restoreState();
        }
        
        // Mark as ready
        this.el.dataset.state = 'ready';
        this.emit?.('ready') || this.dispatchEvent('ready');
        
        if (this.config.analytics) {
          this.trackEvent('filter:initialized');
        }
        
      } catch (error) {
        this.handleError(error);
      }
    }
    
    cacheElements() {
      this.elements = {
        searchInput: this.el.querySelector('.filter__search-input'),
        tagsList: this.el.querySelector('.filter__tags-list'),
        clearBtn: this.el.querySelector('.filter__clear-btn'),
        resultsCount: this.el.querySelector('[data-count="total"]'),
        resultsContent: this.el.querySelector('[data-slot="results"]'),
        emptyState: this.el.querySelector('[data-state="empty"]'),
        loadingState: this.el.querySelector('[data-state="loading"]'),
        announcement: this.el.querySelector('[data-announcement]')
      };
      
      // Generate unique IDs for accessibility
      this.searchId = this.elements.searchInput.id || `filter-search-${Date.now()}`;
      this.elements.searchInput.id = this.searchId;
    }
    
    setupAccessibility() {
      // Enhanced ARIA setup
      this.el.setAttribute('role', 'search');
      this.el.setAttribute('aria-label', 'Advanced content filter');
      
      // Search input enhancements
      this.elements.searchInput.setAttribute('aria-describedby', 'search-help results-count');
      this.elements.searchInput.setAttribute('aria-expanded', 'false');
      this.elements.searchInput.setAttribute('aria-autocomplete', 'list');
      
      // Results area
      this.elements.resultsContent.setAttribute('role', 'region');
      this.elements.resultsContent.setAttribute('aria-label', 'Filtered results');
    }
    
    bindEvents() {
      // Search input with debouncing
      this.elements.searchInput.addEventListener('input', (e) => {
        const value = e.target.value.trim();
        this.updateSearchTerm(value);
      });
      
      // Search input keyboard navigation
      this.elements.searchInput.addEventListener('keydown', (e) => {
        this.handleSearchKeydown(e);
      });
      
      // Clear button
      this.elements.clearBtn.addEventListener('click', () => {
        this.clearAllFilters();
      });
      
      // Tag list delegation
      this.elements.tagsList.addEventListener('change', (e) => {
        if (e.target.matches('.filter__tag-input')) {
          this.handleTagChange(e);
        }
      });
      
      // Keyboard navigation for tags
      this.elements.tagsList.addEventListener('keydown', (e) => {
        if (e.target.matches('.filter__tag-input')) {
          this.handleTagKeydown(e);
        }
      });
      
      // Global keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        this.handleGlobalKeydown(e);
      });
    }
    
    initializeData() {
      // Initialize with data from data attributes or external source
      const initialData = this.el.dataset.items;
      if (initialData) {
        try {
          this.setItems(JSON.parse(initialData));
        } catch (e) {
          console.warn('[RebelFilter] Invalid initial data:', e);
        }
      }
      
      // Initialize tags from data attribute
      const initialTags = this.el.dataset.tags;
      if (initialTags) {
        try {
          this.setTags(JSON.parse(initialTags));
        } catch (e) {
          console.warn('[RebelFilter] Invalid initial tags:', e);
        }
      }
    }
    
    // üîç CORE FILTERING LOGIC
    updateSearchTerm(term) {
      this.state.searchTerm = term;
      this.elements.searchInput.setAttribute('aria-expanded', term.length > 0 ? 'true' : 'false');
      
      if (term.length >= this.config.minSearchLength || term === '') {
        this.debouncedSearch();
      }
      
      this.updateClearButton();
      this.persistState();
    }
    
    handleTagChange(e) {
      const tagValue = e.target.value;
      const isChecked = e.target.checked;
      
      if (isChecked) {
        this.state.selectedTags.add(tagValue);
      } else {
        this.state.selectedTags.delete(tagValue);
      }
      
      this.performSearch();
      this.updateClearButton();
      this.persistState();
      
      // Analytics
      if (this.config.analytics) {
        this.trackEvent('filter:tag-toggle', { tag: tagValue, selected: isChecked });
      }
    }
    
    performSearch() {
      this.setLoading(true);
      
      // Simulate async behavior for better UX
      requestAnimationFrame(() => {
        try {
          let results = [...this.state.items];
          
          // Text search
          if (this.state.searchTerm) {
            const searchTerm = this.config.caseSensitive 
              ? this.state.searchTerm 
              : this.state.searchTerm.toLowerCase();
              
            results = results.filter(item => {
              const searchableText = this.getSearchableText(item);
              const text = this.config.caseSensitive ? searchableText : searchableText.toLowerCase();
              return text.includes(searchTerm);
            });
          }
          
          // Tag filtering
          if (this.state.selectedTags.size > 0) {
            results = results.filter(item => {
              const itemTags = this.getItemTags(item);
              return Array.from(this.state.selectedTags).some(tag => 
                itemTags.includes(tag)
              );
            });
          }
          
          // Limit results for performance
          if (results.length > this.config.maxResults) {
            results = results.slice(0, this.config.maxResults);
          }
          
          this.state.filteredItems = results;
          this.state.totalCount = results.length;
          this.state.isEmpty = results.length === 0;
          
          this.updateResults();
          this.setLoading(false);
          
          // Announce results to screen readers
          if (this.config.announcements) {
            this.debouncedAnnounce();
          }
          
          // Analytics
          if (this.config.analytics) {
            this.trackEvent('filter:search', {
              searchTerm: this.state.searchTerm,
              selectedTags: Array.from(this.state.selectedTags),
              resultCount: results.length
            });
          }
          
        } catch (error) {
          this.handleError(error);
        }
      });
    }
    
    // üé® UI UPDATE METHODS
    updateResults() {
      // Update count
      this.elements.resultsCount.textContent = this.state.totalCount.toLocaleString();
      
      // Show/hide states
      this.elements.emptyState.hidden = !this.state.isEmpty;
      this.elements.resultsContent.hidden = this.state.isEmpty;
      
      // Emit event for external result handling
      this.emit?.('results-updated', {
        items: this.state.filteredItems,
        count: this.state.totalCount,
        isEmpty: this.state.isEmpty
      }) || this.dispatchEvent('results-updated', {
        items: this.state.filteredItems,
        count: this.state.totalCount,
        isEmpty: this.state.isEmpty
      });
    }
    
    updateClearButton() {
      const hasFilters = this.state.searchTerm || this.state.selectedTags.size > 0;
      this.elements.clearBtn.disabled = !hasFilters;
    }
    
    setLoading(isLoading) {
      this.state.isLoading = isLoading;
      this.elements.loadingState.hidden = !isLoading;
      this.el.dataset.state = isLoading ? 'loading' : 'ready';
    }
    
    // üóÇÔ∏è DATA MANAGEMENT
    setItems(items) {
      this.state.items = Array.isArray(items) ? items : [];
      this.performSearch();
    }
    
    addItems(items) {
      const newItems = Array.isArray(items) ? items : [items];
      this.state.items.push(...newItems);
      this.performSearch();
    }
    
    setTags(tags) {
      this.renderTags(tags);
    }
    
    renderTags(tags) {
      const tagHTML = tags.map((tag, index) => `
        <li class="filter__tag">
          <input 
            type="checkbox" 
            class="filter__tag-input" 
            id="tag-${index}" 
            value="${this.escapeHTML(tag.value)}"
            aria-describedby="tag-${index}-count"
          />
          <label class="filter__tag-label" for="tag-${index}">
            ${this.escapeHTML(tag.label)}
            <span class="filter__tag-count" id="tag-${index}-count" aria-label="${tag.count} items">
              ${tag.count}
            </span>
          </label>
        </li>
      `).join('');
      
      this.elements.tagsList.innerHTML = tagHTML;
    }
    
    // üßπ ACTIONS
    clearAllFilters() {
      this.state.searchTerm = '';
      this.state.selectedTags.clear();
      
      this.elements.searchInput.value = '';
      this.elements.tagsList.querySelectorAll('.filter__tag-input').forEach(input => {
        input.checked = false;
      });
      
      this.performSearch();
      this.updateClearButton();
      this.persistState();
      
      // Focus search input for better UX
      this.elements.searchInput.focus();
      
      // Announce action
      this.announce('All filters cleared');
      
      // Analytics
      if (this.config.analytics) {
        this.trackEvent('filter:clear-all');
      }
    }
    
    // ‚å®Ô∏è KEYBOARD NAVIGATION
    handleSearchKeydown(e) {
      switch (e.key) {
        case 'Escape':
          if (this.state.searchTerm) {
            e.preventDefault();
            this.elements.searchInput.value = '';
            this.updateSearchTerm('');
          }
          break;
          
        case 'ArrowDown':
          e.preventDefault();
          this.focusFirstTag();
          break;
      }
    }
    
    handleTagKeydown(e) {
      const currentTag = e.target;
      const tags = Array.from(this.elements.tagsList.querySelectorAll('.filter__tag-input'));
      const currentIndex = tags.indexOf(currentTag);
      
      switch (e.key) {
        case 'ArrowRight':
        case 'ArrowDown':
          e.preventDefault();
          this.focusTag(currentIndex + 1, tags);
          break;
          
        case 'ArrowLeft':
        case 'ArrowUp':
          e.preventDefault();
          this.focusTag(currentIndex - 1, tags);
          break;
          
        case 'Home':
          e.preventDefault();
          this.focusTag(0, tags);
          break;
          
        case 'End':
          e.preventDefault();
          this.focusTag(tags.length - 1, tags);
          break;
      }
    }
    
    handleGlobalKeydown(e) {
      // Ctrl/Cmd + K to focus search
      if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        this.elements.searchInput.focus();
        this.elements.searchInput.select();
      }
    }
    
    focusFirstTag() {
      const firstTag = this.elements.tagsList.querySelector('.filter__tag-input');
      if (firstTag) {
        firstTag.focus();
      }
    }
    
    focusTag(index, tags) {
      const validIndex = Math.max(0, Math.min(index, tags.length - 1));
      tags[validIndex]?.focus();
    }
    
    // üíæ STATE PERSISTENCE
    persistState() {
      if (!this.config.persist) return;
      
      try {
        const state = {
          searchTerm: this.state.searchTerm,
          selectedTags: Array.from(this.state.selectedTags)
        };
        
        sessionStorage.setItem(`rebel-filter-${this.searchId}`, JSON.stringify(state));
      } catch (e) {
        // Ignore storage errors
      }
    }
    
    restoreState() {
      try {
        const saved = sessionStorage.getItem(`rebel-filter-${this.searchId}`);
        if (saved) {
          const state = JSON.parse(saved);
          
          this.state.searchTerm = state.searchTerm || '';
          this.state.selectedTags = new Set(state.selectedTags || []);
          
          // Update UI
          this.elements.searchInput.value = this.state.searchTerm;
          
          this.elements.tagsList.querySelectorAll('.filter__tag-input').forEach(input => {
            input.checked = this.state.selectedTags.has(input.value);
          });
          
          this.performSearch();
          this.updateClearButton();
        }
      } catch (e) {
        // Ignore restore errors
      }
    }
    
    // üì¢ ACCESSIBILITY ANNOUNCEMENTS
    announce(message) {
      if (!this.config.announcements || !this.elements.announcement) return;
      
      this.elements.announcement.textContent = message;
      
      // Clear after delay
      setTimeout(() => {
        this.elements.announcement.textContent = '';
      }, 1000);
    }
    
    announceResults() {
      const count = this.state.totalCount;
      let message;
      
      if (count === 0) {
        message = 'No results found';
      } else if (count === 1) {
        message = '1 result found';
      } else {
        message = `${count} results found`;
      }
      
      this.announce(message);
    }
    
    // üõ†Ô∏è UTILITY METHODS
    getSearchableText(item) {
      if (typeof item === 'string') return item;
      if (item.searchableText) return item.searchableText;
      if (item.title && item.description) return `${item.title} ${item.description}`;
      if (item.title) return item.title;
      if (item.name) return item.name;
      return JSON.stringify(item);
    }
    
    getItemTags(item) {
      if (Array.isArray(item.tags)) return item.tags;
      if (item.category) return [item.category];
      if (item.type) return [item.type];
      return [];
    }
    
    escapeHTML(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }
    
    debounce(func, delay) {
      let timeoutId;
      return (...args) => {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => func.apply(this, args), delay);
      };
    }
    
    // üìä ANALYTICS & TRACKING
    trackEvent(eventName, data = {}) {
      if (window.gtag) {
        gtag('event', eventName, {
          component: 'rebel-filter',
          version: this.version,
          ...data
        });
      }
      
      // Custom analytics
      this.emit?.('analytics', { event: eventName, data }) || 
      this.dispatchEvent('analytics', { event: eventName, data });
    }
    
    // üö® ERROR HANDLING
    handleError(error) {
      console.error('[RebelFilter] Error:', error);
      this.el.dataset.state = 'error';
      this.setLoading(false);
      
      this.announce('An error occurred while filtering');
      
      this.emit?.('error', { error }) || this.dispatchEvent('error', { error });
    }
    
    // üé≠ EVENT SYSTEM
    emit(eventName, detail = {}) {
      if (super.emit) {
        return super.emit(eventName, detail);
      }
      return this.dispatchEvent(eventName, detail);
    }
    
    dispatchEvent(eventName, detail = {}) {
      const event = new CustomEvent(`rebel:filter:${eventName}`, {
        detail: { instance: this, ...detail },
        bubbles: true,
        cancelable: true
      });
      
      this.el.dispatchEvent(event);
      return event;
    }
    
    on(eventName, handler) {
      this.el.addEventListener(`rebel:filter:${eventName}`, handler);
      return () => this.off(eventName, handler);
    }
    
    off(eventName, handler) {
      this.el.removeEventListener(`rebel:filter:${eventName}`, handler);
    }
    
    // üßπ CLEANUP
    destroy() {
      // Clear timers
      if (this.debouncedSearch) {
        clearTimeout(this.debouncedSearch.timeoutId);
      }
      if (this.debouncedAnnounce) {
        clearTimeout(this.debouncedAnnounce.timeoutId);
      }
      
      // Remove global listeners
      document.removeEventListener('keydown', this.handleGlobalKeydown);
      
      // Clear persisted state
      if (this.config.persist) {
        try {
          sessionStorage.removeItem(`rebel-filter-${this.searchId}`);
        } catch (e) {
          // Ignore
        }
      }
      
      // Call parent destroy
      if (super.destroy) {
        super.destroy();
      }
      
      this.dispatchEvent('destroyed');
    }
    
    // üîç PUBLIC API
    search(term) {
      this.elements.searchInput.value = term;
      this.updateSearchTerm(term);
    }
    
    selectTag(tagValue) {
      const tagInput = this.elements.tagsList.querySelector(`[value="${tagValue}"]`);
      if (tagInput) {
        tagInput.checked = true;
        this.handleTagChange({ target: tagInput });
      }
    }
    
    getResults() {
      return {
        items: this.state.filteredItems,
        count: this.state.totalCount,
        isEmpty: this.state.isEmpty
      };
    }
    
    getState() {
      return {
        searchTerm: this.state.searchTerm,
        selectedTags: Array.from(this.state.selectedTags),
        totalCount: this.state.totalCount
      };
    }
  }
  
  // üöÄ AUTO-INITIALIZATION
  function initRebelFilters() {
    const filters = document.querySelectorAll('[data-cs="rebel-filter"]:not([data-init="true"])');
    
    filters.forEach(element => {
      try {
        const strategy = element.dataset.init || 'eager';
        
        switch (strategy) {
          case 'eager':
            new RebelFilter(element);
            break;
            
          case 'visible':
            const observer = new IntersectionObserver((entries) => {
              entries.forEach(entry => {
                if (entry.isIntersecting) {
                  new RebelFilter(entry.target);
                  observer.unobserve(entry.target);
                }
              });
            });
            observer.observe(element);
            break;
            
          case 'interaction':
            const initOnInteraction = () => {
              new RebelFilter(element);
              ['mouseenter', 'focus', 'click'].forEach(event => {
                element.removeEventListener(event, initOnInteraction);
              });
            };
            
            ['mouseenter', 'focus', 'click'].forEach(event => {
              element.addEventListener(event, initOnInteraction, { once: true, passive: true });
            });
            break;
        }
      } catch (error) {
        console.error('Failed to initialize RebelFilter:', error);
        element.dataset.state = 'error';
      }
    });
  }
  
  // Register with Rebel system if available
  if (window.R?.register) {
    window.R.register('rebel-filter', RebelFilter);
  }
  
  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initRebelFilters);
  } else {
    initRebelFilters();
  }
  
  // Webflow integration
  if (window.Webflow) {
    window.Webflow.push(initRebelFilters);
  }
  
  // Mutation observer for dynamic content
  if (window.MutationObserver) {
    const observer = new MutationObserver((mutations) => {
      let hasNewFilters = false;
      
      mutations.forEach(mutation => {
        mutation.addedNodes.forEach(node => {
          if (node.nodeType === 1) {
            if (node.matches?.('[data-cs="rebel-filter"]:not([data-init="true"])')) {
              hasNewFilters = true;
            } else if (node.querySelector?.('[data-cs="rebel-filter"]:not([data-init="true"])')) {
              hasNewFilters = true;
            }
          }
        });
      });
      
      if (hasNewFilters) {
        setTimeout(initRebelFilters, 10);
      }
    });
    
    observer.observe(document.body, {
      childList: true,
      subtree: true
    });
  }
  
})();
</script>

</div>
